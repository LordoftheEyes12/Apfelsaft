<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apfelsaft ‚Äî News</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .nav { display:flex; align-items:center; gap:.75rem; }
    .btn { display:inline-block; padding:.4rem .7rem; border:1px solid #00000022; border-radius:.6rem; text-decoration:none; }
    .btn:hover { background:#0000000a; }
  </style>
</head>
<body>
  <header class="container nav">
    <a href="#/" class="btn" id="homeBtn" aria-label="Home">üè† Home</a>
    <h1 style="margin:0;">Apfelsaft</h1>
    <span class="muted" id="subtitle">Read-only safe</span>
  </header>

  <main class="container" id="app"></main>

  <script>
  // --- simple client-side state ---
  const state = {
    list: [],
    byId: new Map(), // String(id) -> article
    loadedAt: 0
  };

  // --- API helpers ---
  async function apiList() {
    const r = await fetch("/api/articles", { cache: "no-store" });
    if (!r.ok) throw new Error("Failed to load list");
    return r.json(); // { articles: [...] }
  }
  async function apiGet(id) {
    const r = await fetch(`/api/articles/${encodeURIComponent(id)}`, { cache: "no-store" });
    if (!r.ok) throw new Error("Not found");
    return r.json(); // Article
  }

  // --- DOM refs ---
  const app = document.getElementById("app");
  const subtitle = document.getElementById("subtitle");

  // --- utils ---
  function nl2br(str="") {
    return String(str).replace(/&/g,"&amp;")
                      .replace(/</g,"&lt;")
                      .replace(/>/g,"&gt;")
                      .replace(/\n/g,"<br/>");
  }
  function idKey(v){ return String(v); }

  function buildIndex(articles){
    state.byId.clear();
    state.list = articles || [];
    state.list.forEach(a => state.byId.set(idKey(a.id), a));
    state.loadedAt = Date.now();
  }

  // --- UI renderers ---
  async function renderList(forceReload=false) {
    subtitle.textContent = "Latest";
    app.innerHTML = `<p class="muted">Loading‚Ä¶</p>`;
    try {
      if (forceReload || state.list.length === 0) {
        const data = await apiList();
        buildIndex(data.articles || []);
      }
      if (!state.list.length) {
        app.innerHTML = `<p class="muted">No articles yet.</p>`;
        return;
      }
      app.innerHTML = state.list.map(a => `
        <article class="card">
          <h2><a href="#/article/${encodeURIComponent(a.id)}">${a.headline}</a></h2>
          <p>${(a.content || "").slice(0, 200)}${(a.content||"").length>200?"‚Ä¶":""}</p>
          <div class="meta">${a.createdAt ? new Date(a.createdAt).toLocaleString() : ""}</div>
          <div><a class="btn" href="#/article/${encodeURIComponent(a.id)}">Read</a></div>
        </article>
      `).join("");
    } catch (e) {
      app.innerHTML = `<p class="muted">Failed to load: ${e.message}</p>`;
    }
    document.title = "Apfelsaft ‚Äî News";
  }

  async function renderArticle(id) {
    subtitle.textContent = "Article";
    app.innerHTML = `<p class="muted">Loading article‚Ä¶</p>`;

    // 1) try client-side cache first (handles serverless instance mismatch)
    let a = state.byId.get(idKey(id));

    // 2) if not present, try reloading list once (maybe page was opened directly on #/article/ID)
    if (!a) {
      try {
        const data = await apiList();
        buildIndex(data.articles || []);
        a = state.byId.get(idKey(id));
      } catch {}
    }

    // 3) as a final fallback, hit the detail endpoint
    if (!a) {
      try { a = await apiGet(id); }
      catch {
        app.innerHTML = `
          <nav style="margin-bottom:1rem;">
            <a class="btn" href="#/">‚Üê Back</a>
          </nav>
          <p class="muted">Article not found.</p>
        `;
        document.title = "Apfelsaft ‚Äî Not found";
        return;
      }
    }

    app.innerHTML = `
      <nav style="margin-bottom:1rem;">
        <a class="btn" href="#/">‚Üê Back</a>
      </nav>
      <article class="card">
        <h1 style="margin-top:0;">${a.headline}</h1>
        <div class="meta">${a.createdAt ? new Date(a.createdAt).toLocaleString() : ""}</div>
        <div style="margin-top:1rem; line-height:1.6;">${nl2br(a.content)}</div>
      </article>
    `;
    document.title = `Apfelsaft ‚Äî ${a.headline}`;
  }

  // --- tiny hash router ---
  function parseHash() {
    const h = location.hash || "#/";
    const parts = h.slice(2).split("/"); // remove "#/"
    return parts;
  }

  async function router() {
    const parts = parseHash();
    if (!parts[0]) return renderList();
    if (parts[0] === "article" && parts[1]) return renderArticle(decodeURIComponent(parts[1]));
    return renderList();
  }

  window.addEventListener("hashchange", router);
  // initial load: also build cache so details work immediately
  renderList(true).then(router);
</script>

</body>
</html>
